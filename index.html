<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីគ្រប់គ្រងរបាយការណ៍វត្តមាន</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Koulen&family=Moul&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Koulen', sans-serif;
        }
        .table-header {
            font-family: 'Moul', serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 table-header">សូមចូលប្រើប្រាស់ប្រព័ន្ធ</h1>
                <p class="text-gray-500 mt-2">ជ្រើសរើសគណនី និងបញ្ចូលពាក្យសម្ងាត់</p>
            </div>

            <!-- User Login Section -->
            <div id="login-section">
                <div class="mb-4">
                    <label for="user-select" class="block text-sm font-medium text-gray-700 mb-2">ជ្រើសរើសឈ្មោះ:</label>
                    <select id="user-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- សូមជ្រើសរើស --</option>
                        <option value="povk35808@gmail.com">MMK</option>
                        <option value="bonchantha43@gmail.com">ប៊ន ចន្ថា</option>
                        <option value="chhanonlork87@gmail.com">ឡោក ឆាណុន</option>
                        <option value="roeunsreyneth2026@gmail.com">រឿន ស្រណែត</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="password-input" class="block text-sm font-medium text-gray-700 mb-2">ពាក្យសម្ងាត់:</label>
                    <input type="password" id="password-input" placeholder="វាយបញ្ចូលពាក្យសម្ងាត់" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <button id="login-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-10 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300">
                    ចូលប្រើប្រាស់
                </button>
            </div>
             <div id="login-status" class="mt-4 text-center"></div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden p-4">
        <div class="w-full bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <div class="relative">
                <div class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800 table-header">កម្មវិធីគ្រប់គ្រងរបាយការណ៍វត្តមាន</h1>
                    <p class="text-gray-500 mt-2">នាំចូល (Import) ឯកសារ Excel ដើម្បីបង្ហាញ និងរក្សាទុកទិន្នន័យ</p>
                </div>
                <div class="absolute top-0 right-0 flex space-x-2">
                    <a href="https://darotrb0-bit.github.io/UpdateScanDIDaily/" target="_blank" title="ភ្ជាប់កម្មវិធីរបាយការណ៍" class="p-2 text-gray-500 hover:text-blue-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
                            <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
                        </svg>
                    </a>
                    <button id="logout-btn" title="ចាកចេញ" class="p-2 text-gray-500 hover:text-red-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                            <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>

             <!-- Search Input -->
            <div class="mb-4">
                <input type="text" id="search-input" placeholder="ស្វែងរកតាមឈ្មោះ, អត្តលេខ, ផ្នែក, ក្រុម, ថ្នាក់..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- File Upload Section -->
            <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">ជ្រើសរើសឯកសារ Excel</h2>
                <p class="text-sm text-gray-500 mb-4">ឯកសារត្រូវមានទិន្នន័យ អត្តលេខ, កាលបរិច្ឆេទ, ម៉ោងចូល, និងម៉ោងចេញ។</p>
                <input type="file" id="excel-file-input" accept=".xlsx, .xls" class="block w-full max-w-xs mx-auto text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            </div>

            <!-- Status Message Area -->
            <div id="status-message" class="hidden my-4 p-4 rounded-md text-center"></div>

            <!-- Data Preview Table -->
            <div class="overflow-x-auto mb-6">
                <table class="w-full bg-white border border-gray-200 rounded-lg">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left text-sm font-bold text-gray-600 uppercase table-header">#</th>
                            <th class="py-3 px-4 text-left text-sm font-bold text-gray-600 uppercase table-header">ក្រុម</th>
                            <th class="py-3 px-4 text-left text-sm font-bold text-gray-600 uppercase table-header">ថ្នាក់</th>
                            <th class="py-3 px-4 text-left text-sm font-bold text-gray-600 uppercase table-header">ផ្នែកការងារ</th>
                            <th class="py-3 px-4 text-left text-sm font-bold text-gray-600 uppercase table-header">ឈ្មោះ</th>
                            <th class="py-3 px-4 text-left text-sm font-bold text-gray-600 uppercase table-header">ភេទ</th>
                            <th class="py-3 px-4 text-left text-sm font-bold text-gray-600 uppercase table-header">អត្តលេខ</th>
                            <th class="py-3 px-4 text-left text-sm font-bold text-gray-600 uppercase table-header">កាលបរិច្ឆេទ</th>
                            <th class="py-3 px-4 text-left text-sm font-bold text-gray-600 uppercase table-header">កាលវិភាគ</th>
                            <th class="py-3 px-4 text-left text-sm font-bold text-gray-600 uppercase table-header" style="min-width: 150px;">ម៉ោងចូល</th>
                            <th class="py-3 px-4 text-left text-sm font-bold text-gray-600 uppercase table-header" style="min-width: 150px;">ម៉ោងចេញ</th>
                            <th class="py-3 px-4 text-center text-sm font-bold text-gray-600 uppercase table-header">សកម្មភាព</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <tr>
                            <td colspan="12" class="text-center py-10 px-4 text-gray-500">មិនទាន់មានទិន្នន័យ... សូមជ្រើសរើសឯកសារ Excel។</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Save Button -->
            <div class="text-center">
                <button id="save-button" disabled class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-10 rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all duration-300 flex items-center justify-center mx-auto">
                    <span id="save-button-text">រក្សាទុកទិន្នន័យ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center w-11/12 md:max-w-md mx-auto">
            <h3 class="text-xl font-bold mb-4 table-header">បញ្ជាក់ការលុប</h3>
            <p id="modal-message" class="mb-6 text-gray-700">តើអ្នកពិតជាចង់លុបជួរដេកនេះមែនទេ?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">បោះបង់</button>
                <button id="confirm-delete-btn" class="w-full md:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">យល់ព្រមលុប</button>
            </div>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        const googleAppScriptUrl = 'https://script.google.com/macros/s/AKfycbx1KErI37zcGzm6hTBQATrLHxg6Wc0zuUvTQ9G8iaR5l3NMO8aQzy0mtQ7MzOjEveB_9A/exec';

        // --- DOM ELEMENTS ---
        const loginOverlay = document.getElementById('login-overlay');
        const mainApp = document.getElementById('main-app');
        const userSelect = document.getElementById('user-select');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const loginStatus = document.getElementById('login-status');
        const logoutBtn = document.getElementById('logout-btn');
        
        const fileInput = document.getElementById('excel-file-input');
        const dataTableBody = document.getElementById('data-table-body');
        const saveButton = document.getElementById('save-button');
        const saveButtonText = document.getElementById('save-button-text');
        const statusMessage = document.getElementById('status-message');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const searchInput = document.getElementById('search-input');
        
        // --- GLOBAL STATE ---
        let attendanceData = [];
        let rowIndexToDelete = null;

        // --- LOGIN & SESSION LOGIC ---
        document.addEventListener('DOMContentLoaded', checkLoginSession);
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);

        function checkLoginSession() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                loginOverlay.classList.add('hidden');
                mainApp.classList.remove('hidden');
            } else {
                loginOverlay.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        }

        function handleLogout() {
            localStorage.removeItem('loggedInUser');
            checkLoginSession();
        }

        function showLoginStatus(message, isError = false) {
            loginStatus.textContent = message;
            loginStatus.className = `mt-4 text-center ${isError ? 'text-red-500' : 'text-green-500'}`;
        }

        async function handleLogin() {
            const selectedEmail = userSelect.value;
            const enteredPassword = passwordInput.value;

            if (!selectedEmail) {
                showLoginStatus('សូមជ្រើសរើសឈ្មោះរបស់អ្នក!', true);
                return;
            }
            if (!enteredPassword) {
                showLoginStatus('សូមវាយបញ្ចូលពាក្យសម្ងាត់!', true);
                return;
            }
            
            this.disabled = true;
            this.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>កំពុងចូលប្រើ...</span>`;
            showLoginStatus('កំពុងផ្ទៀងផ្ទាត់...', false);

            try {
                const response = await fetch(googleAppScriptUrl, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'login', email: selectedEmail, password: enteredPassword }),
                    redirect: 'follow'
                });
                if (!response.ok) throw new Error('Network error during login.');
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);

                showLoginStatus('ការចូលប្រើបានជោគជ័យ!', false);
                localStorage.setItem('loggedInUser', selectedEmail); // Save session
                checkLoginSession(); // Show main app

            } catch (error) {
                console.error("Error logging in:", error);
                showLoginStatus(`ការចូលប្រើបានបរាជ័យ: ${error.message}`, true);
            } finally {
                 this.disabled = false;
                 this.innerHTML = 'ចូលប្រើប្រាស់';
            }
        }

        // --- MAIN APP LOGIC ---
        fileInput.addEventListener('change', handleFileSelect);
        saveButton.addEventListener('click', saveDataToGoogleSheet);
        dataTableBody.addEventListener('click', handleTableClick);
        dataTableBody.addEventListener('input', handleInputChange);
        confirmDeleteBtn.addEventListener('click', executeDelete);
        cancelDeleteBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
        searchInput.addEventListener('input', () => displayDataInTable(searchInput.value.toLowerCase()));

        function handleTableClick(event) {
            const deleteButton = event.target.closest('.delete-btn');
            if (deleteButton) {
                rowIndexToDelete = parseInt(deleteButton.dataset.index, 10);
                confirmationModal.classList.remove('hidden');
            }
        }

        function handleInputChange(event) {
            const target = event.target;
            if (target.tagName === 'INPUT' && target.dataset.index) {
                const index = parseInt(target.dataset.index, 10);
                const field = target.dataset.field;
                if (attendanceData[index] && field) {
                    attendanceData[index][field] = target.value;
                }
            }
        }

        function executeDelete() {
            if (rowIndexToDelete !== null) {
                attendanceData.splice(rowIndexToDelete, 1);
                displayDataInTable(searchInput.value.toLowerCase());
                showMessage('បានលុបជួរដេកដោយជោគជ័យ។', 'success');
            }
            confirmationModal.classList.add('hidden');
            rowIndexToDelete = null;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            resetState();
            showMessage('កំពុងអានឯកសារ Excel...', 'info');

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: 1 });

                    if (jsonData.length === 0) throw new Error("ឯកសារ Excel មិនមានទិន្នន័យចាប់ពីជួរដេកទី២ទេ។");
                    
                    attendanceData = jsonData.map(row => {
                        if (!row || !row[0]) return null;
                        return {
                            id: row[0], date: formatDate(row[1]), schedule: row[2] || '',
                            checkin: formatTime(row[3]), checkout: formatTime(row[4]),
                            group: '', class: '', department: '', name: '', gender: ''
                        };
                    }).filter(item => item !== null);

                    const idsToLookup = [...new Set(attendanceData.map(record => String(record.id)))];

                    if (idsToLookup.length > 0) {
                        await fetchAndMergeDetails(idsToLookup);
                    } else {
                        displayDataInTable();
                        saveButton.disabled = attendanceData.length === 0;
                        showMessage(`បាននាំចូលទិន្នន័យ ${attendanceData.length} ជួរ។`, 'success');
                    }
                } catch (error) {
                    console.error("Error processing Excel file:", error);
                    showMessage(error.message, 'error');
                    resetState();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function fetchAndMergeDetails(ids) {
            showMessage('បាននាំចូលទិន្នន័យ។ កំពុងទាញយកព័ត៌មានលម្អិត...', 'info');
            try {
                const response = await fetch(googleAppScriptUrl, {
                    method: 'POST', mode: 'cors', credentials: 'omit',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'lookup', ids: ids }),
                    redirect: 'follow'
                });

                if (!response.ok) throw new Error(`Network response was not ok, status: ${response.status}`);
                
                const detailsMap = await response.json();
                if(detailsMap.status === 'error') throw new Error(detailsMap.message);

                attendanceData.forEach(record => {
                    const details = detailsMap[String(record.id)];
                    if (details) {
                        Object.assign(record, details);
                    }
                });
                
                displayDataInTable();
                saveButton.disabled = false;
                showMessage(`បាននាំចូល និងធ្វើបច្ចុប្បន្នភាពទិន្នន័យ ${attendanceData.length} ជួរ។`, 'success');

            } catch (error) {
                console.error('Error fetching details:', error);
                showMessage('មានបញ្ហាក្នុងការទាញយកព័ត៌មានលម្អិត។ ទិន្នន័យខ្លះអាចនឹងមិនពេញលេញ។', 'error');
                displayDataInTable();
                saveButton.disabled = false;
            }
        }

        function displayDataInTable(searchTerm = '') {
            const filteredData = attendanceData.filter(record => {
                return (record.name && record.name.toLowerCase().includes(searchTerm)) ||
                       (record.id && String(record.id).toLowerCase().includes(searchTerm)) ||
                       (record.department && record.department.toLowerCase().includes(searchTerm)) ||
                       (record.group && record.group.toLowerCase().includes(searchTerm)) ||
                       (record.class && record.class.toLowerCase().includes(searchTerm));
            });

            dataTableBody.innerHTML = '';
            if (filteredData.length === 0) {
                const message = searchTerm ? 'មិនមានទិន្នន័យត្រូវនឹងការស្វែងរកទេ។' : 'មិនមានទិន្នន័យសម្រាប់បង្ហាញទេ។';
                dataTableBody.innerHTML = `<tr><td colspan="12" class="text-center py-10 px-4 text-gray-500">${message}</td></tr>`;
                saveButton.disabled = attendanceData.length === 0;
                return;
            }
            
            filteredData.forEach((record, index) => {
                const originalIndex = attendanceData.indexOf(record);
                const isLocked = record.department === 'IT support';
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-2 px-4 text-gray-700 align-middle">${index + 1}</td>
                    <td class="py-2 px-4 text-gray-700 align-middle">${record.group || ''}</td>
                    <td class="py-2 px-4 text-gray-700 align-middle">${record.class || ''}</td>
                    <td class="py-2 px-4 text-gray-700 align-middle">${record.department || ''}</td>
                    <td class="py-2 px-4 text-gray-700 align-middle">${record.name || ''}</td>
                    <td class="py-2 px-4 text-gray-700 align-middle">${record.gender || ''}</td>
                    <td class="py-2 px-4 text-gray-700 align-middle">${record.id}</td>
                    <td class="py-2 px-4 text-gray-700 align-middle">${record.date}</td>
                    <td class="py-2 px-4 text-gray-700 align-middle">${record.schedule}</td>
                    <td class="py-1 px-2 align-middle">
                        <input type="text" value="${record.checkin || ''}" 
                               class="w-full bg-transparent p-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed disabled:border-gray-200" 
                               data-index="${originalIndex}" data-field="checkin" ${isLocked ? 'disabled' : ''}>
                    </td>
                    <td class="py-1 px-2 align-middle">
                        <input type="text" value="${record.checkout || ''}" 
                               class="w-full bg-transparent p-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed disabled:border-gray-200" 
                               data-index="${originalIndex}" data-field="checkout" ${isLocked ? 'disabled' : ''}>
                    </td>
                    <td class="py-2 px-4 text-center align-middle">
                        ${!isLocked ? `
                        <button class="delete-btn text-red-500 hover:text-red-700" data-index="${originalIndex}" title="លុប">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                                <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
                            </svg>
                        </button>
                        ` : `
                        <div class="flex justify-center items-center h-full" title="មិនអាចកែប្រែបានទេ">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-lock-fill text-gray-400" viewBox="0 0 16 16">
                                <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                            </svg>
                        </div>
                        `}
                    </td>
                `;
                dataTableBody.appendChild(row);
            });
            saveButton.disabled = attendanceData.length === 0;
        }
        
        async function saveDataToGoogleSheet() {
            if (attendanceData.length === 0) {
                showMessage('មិនមានទិន្នន័យសម្រាប់រក្សាទុកទេ។', 'warning');
                return;
            }

            saveButton.disabled = true;
            saveButtonText.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>កំពុងរក្សាទុក...</span>`;
            showMessage('កំពុងបញ្ជូនទិន្នន័យ និងត្រួតពិនិត្យភាពស្ទួន...', 'info');

            try {
                const response = await fetch(googleAppScriptUrl, {
                    method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'save', data: attendanceData }),
                    redirect: 'follow'
                });
                
                if (!response.ok) throw new Error(`Network error: ${response.status}`);
                const result = await response.json();
                
                showMessage(result.message, result.status);
                
                if (result.status === 'success') {
                    resetState();
                }

            } catch (error) {
                console.error('Error in save process:', error);
                showMessage(`ដំណើរការរក្សាទុកបានបរាជ័យ: ${error.message}`, 'error');
            } finally {
                saveButton.disabled = false;
                saveButtonText.innerHTML = 'រក្សាទុកទិន្នន័យ';
            }
        }
        
        // --- HELPER FUNCTIONS ---

        function resetState() {
            attendanceData = [];
            dataTableBody.innerHTML = `<tr><td colspan="12" class="text-center py-10 px-4 text-gray-500">មិនទាន់មានទិន្នន័យ... សូមជ្រើសរើសឯកសារ Excel។</td></tr>`;
            saveButton.disabled = true;
            saveButtonText.innerHTML = 'រក្សាទុកទិន្នន័យ';
            fileInput.value = '';
            searchInput.value = '';
        }

        function showMessage(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'my-4 p-4 rounded-md text-center text-white transition-all duration-300';
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500', warning: 'bg-yellow-500' };
            statusMessage.classList.add(colors[type] || 'bg-gray-500');
            statusMessage.classList.remove('hidden');
        }

        function formatDate(dateInput) {
            if (!dateInput) return '';
            try {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                let date = dateInput instanceof Date ? dateInput : new Date(dateInput);
                 if (typeof dateInput === 'number') {
                     const excelEpoch = new Date(1899, 11, 30);
                     date = new Date(excelEpoch.getTime() + dateInput * 86400000);
                 }
                if (isNaN(date.getTime())) return '';
                const day = String(date.getDate()).padStart(2, '0');
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                return `${day}-${month}-${year}`;
            } catch { return ''; }
        }

        function formatTime(timeInput) {
            if (timeInput === null || timeInput === undefined) return '';
            if (timeInput instanceof Date && !isNaN(timeInput)) {
                return timeInput.toTimeString().slice(0, 5);
            }
            if (typeof timeInput === 'number' && timeInput >= 0 && timeInput < 1) {
                const date = new Date(Math.round((timeInput - 25569) * 86400 * 1000));
                return date.toTimeString().slice(0, 5);
            }
            // If the input is already a string in HH:mm format, just return it.
            const timeString = String(timeInput).trim();
            return timeString !== '' ? timeString : '';
        }
    </script>
</body>
</html>

